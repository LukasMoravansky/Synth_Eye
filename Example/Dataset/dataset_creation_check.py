# System (Default)
import sys
#   Add access if it is not in the system path.
if '../../' + 'src' not in sys.path:
    sys.path.append('../../' + 'src')
# OS (Operating system interfaces)
import os
# OpenCV (Computer Vision) [pip3 install opencv-python]
import cv2
# Custom Library:
#   ../Utilities/Image_Processing
import Utilities.Image_Processing
#   ../Utilities/File_IO
import Utilities.File_IO as File_IO

"""
Description:
    Initialization of constants.
"""
# The identification number of the iteration to evaluate the image. It starts with the number 1.
#   1 = 'Image_001', 2 = 'Image_002', etc.
CONST_INIT_INDEX = 5297 # 5398, 5394, 5386, 5376, 5360, 5343, 5297, 5062
# Dataset partition name used for evaluation (e.g., 'train', 'valid', or 'test')
CONST_PARTITION_NAME = 'train'
# The name of the dataset and color of the object bounding boxes.
#   Dataset_v2 - [(255, 165, 0), (0, 165, 255)]
#   Dataset_v3 - [(80, 0, 255)]
CONST_DATASET = {'Name': 'Dataset_v2', 'Color': [(255, 165, 0), (0, 165, 255)]}

def main():
    """
    Description:
        A program to evaluate data (image with corresponding label) generated from Blender 
        or a real-world camera.
    """

    # Locate the path to the project folder.
    project_folder = os.getcwd().split('Synth_Eye')[0] + 'Synth_Eye'
    image_path = os.path.join(project_folder, 'Data', CONST_DATASET['Name'], 'images', CONST_PARTITION_NAME, 
                              f'Image_{CONST_INIT_INDEX:03}.png')
    label_path = os.path.join(project_folder, 'Data', CONST_DATASET['Name'], 'labels', CONST_PARTITION_NAME, 
                              f'Image_{CONST_INIT_INDEX:03}')

    # Load image and label data.
    image_data = cv2.imread(image_path)
    if image_data is None:
        raise FileNotFoundError(f'Image file not found: {image_path}')
    label_data = File_IO.Load(label_path, 'txt', ' ')
    if hasattr(label_data, 'size') and label_data.size == 0:
        raise FileNotFoundError(f'Label file not found or empty: {label_path}')

    for i, label_data_i in enumerate(label_data):
        # Convert label values to appropriate types
        obj_id = int(label_data_i[0])
        x_c, y_c = float(label_data_i[1]), float(label_data_i[2])
        width, height = float(label_data_i[3]), float(label_data_i[4])

        bounding_box_props = {
            'Name': f'{obj_id}_{i}',
            'Precision': None,
            'Data': {'x_c': x_c, 'y_c': y_c, 'width': width, 'height': height}
        }

        image_data = Utilities.Image_Processing.Draw_Bounding_Box(
            image_data, bounding_box_props, 'YOLO', CONST_DATASET['Color'][obj_id], True, False
        )

    # Uncomment to display the image in a window
    # cv2.imshow('Synthetic Data Generated by Blender', image_data)
    # cv2.waitKey(0)
    # cv2.destroyAllWindows()

    output_filename = f'{CONST_DATASET['Name']}_{CONST_PARTITION_NAME}_Image_{CONST_INIT_INDEX:03}_Evaluated.png'
    cv2.imwrite(output_filename, image_data)
    print(f'Saved annotated image to {output_filename}')
    
if __name__ == '__main__':
    sys.exit(main())